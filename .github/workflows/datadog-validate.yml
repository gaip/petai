name: Datadog Infrastructure Validation

on:
  pull_request:
    paths:
      - 'terraform/datadog/**'
      - 'backend/**/*.py'
      - '.github/workflows/datadog-validate.yml'
  workflow_dispatch:

jobs:
  terraform-security:
    name: Security Scan (tfsec)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform/datadog
          soft_fail: true

  terraform-cost-estimate:
    name: Cost Estimate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate cost estimate
        if: env.INFRACOST_API_KEY != ''
        run: |
          infracost breakdown --path=terraform/datadog \
            --format=json \
            --out-file=/tmp/infracost.json
        continue-on-error: true
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}

      - name: Comment cost estimate
        if: github.event_name == 'pull_request' && env.INFRACOST_API_KEY != ''
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost.json
          behavior: update
        continue-on-error: true
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}

  metrics-validation:
    name: Validate Metrics Implementation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install datadog pytest
        working-directory: backend

      - name: Check metrics namespace consistency
        run: |
          echo "Checking for 'pettwin' namespace in Python code..."
          grep -r "namespace.*pettwin" backend/ || echo "âš ï¸ Warning: Namespace not found in backend"
          grep -r "statsd\." backend/ && echo "âœ… StatsD calls found" || echo "âŒ No StatsD calls found"

      - name: Validate metric names match Terraform
        run: |
          # Extract metric names from Terraform
          echo "Extracting metrics from Terraform..."
          grep -o "pettwin\.[a-z._]*" terraform/datadog/*.tf | sort -u > /tmp/terraform_metrics.txt

          # Extract metric names from Python
          echo "Extracting metrics from Python..."
          grep -o "pettwin\.[a-z._]*" backend/*.py | sort -u > /tmp/python_metrics.txt

          echo "ðŸ“Š Metrics defined in Terraform:"
          cat /tmp/terraform_metrics.txt

          echo ""
          echo "ðŸ“Š Metrics sent from Python:"
          cat /tmp/python_metrics.txt

          echo ""
          echo "âœ… Validation complete"

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README completeness
        run: |
          files=(
            "terraform/datadog/README.md"
            "backend/DATADOG_AGENT_README.md"
            "docs/DATADOG_IMPLEMENTATION.md"
          )

          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
              lines=$(wc -l < "$file")
              echo "   Lines: $lines"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done

      - name: Check for broken links in README
        run: |
          # Check for common broken link patterns
          if grep -r "https://app.datadoghq.eu/dashboard/YOUR_DASHBOARD_ID" terraform/datadog/README.md; then
            echo "âŒ Found placeholder URL in README"
            exit 1
          fi
          echo "âœ… No placeholder URLs found"

      - name: Verify configuration examples exist
        run: |
          if [ ! -f "terraform/datadog/terraform.tfvars.example" ]; then
            echo "âŒ Missing terraform.tfvars.example"
            exit 1
          fi

          if [ ! -f "backend/.env.example" ]; then
            echo "âŒ Missing backend/.env.example"
            exit 1
          fi

          echo "âœ… All configuration examples exist"

  integration-test:
    name: Integration Test (Dry Run)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: terraform/datadog

      - name: Generate test tfvars
        run: |
          cat > terraform.tfvars <<EOF
          datadog_api_key = "test_key_for_validation"
          datadog_app_key = "test_app_key_for_validation"
          datadog_api_url = "https://api.datadoghq.eu/api/v1"
          alert_email     = "test@example.com"
          EOF
        working-directory: terraform/datadog

      - name: Terraform Validate with test config
        run: terraform validate
        working-directory: terraform/datadog

      - name: Clean up test files
        run: rm terraform.tfvars
        working-directory: terraform/datadog

  pr-summary:
    name: Generate PR Summary
    runs-on: ubuntu-latest
    needs: [terraform-security, metrics-validation, documentation-check, integration-test]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Create PR Summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ðŸ” Datadog Infrastructure Validation Summary

            ### Checks Status
            - **Security Scan**: ${{ needs.terraform-security.result == 'success' ? 'âœ…' : 'âŒ' }}
            - **Metrics Validation**: ${{ needs.metrics-validation.result == 'success' ? 'âœ…' : 'âŒ' }}
            - **Documentation**: ${{ needs.documentation-check.result == 'success' ? 'âœ…' : 'âŒ' }}
            - **Integration Test**: ${{ needs.integration-test.result == 'success' ? 'âœ…' : 'âŒ' }}

            ### ðŸ“‹ Resources Overview
            This PR modifies Datadog infrastructure:
            - **Dashboards**: 2 (Technical + Executive)
            - **Monitors**: 12 (6 core + 6 advanced)
            - **SLOs**: 5 service level objectives
            - **Metrics**: 15+ custom metrics

            ### ðŸš€ Deployment
            Once approved and merged to main, this will:
            1. Run \`terraform plan\` to preview changes
            2. Deploy to Datadog production environment
            3. Update dashboards and monitors
            4. Post deployment URLs in summary

            ---
            *Automated validation by GitHub Actions*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
